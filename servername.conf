# =======================
# /etc/apache2/sites-available/sito.conf
# =======================

# --- VHOST ONION: chiaro su :80, nessun redirect ---
<VirtualHost *:80>
    ServerName sito.onion
    ServerAdmin webmaster@sito.onion

    DocumentRoot /var/www/onion-site
    <Directory /var/www/onion-site>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Sicurezza base (non troppo restrittiva per non rompere il sito)
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # CORS "safe": abilita GET/HEAD su asset senza rompere rendering
    <If "%{REQUEST_METHOD} == 'GET' || %{REQUEST_METHOD} == 'HEAD'">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, HEAD"
        Header always set Access-Control-Allow-Headers "Content-Type"
    </If>

    # Log separati per lâ€™onion
    ErrorLog  ${APACHE_LOG_DIR}/onion-error.log
    CustomLog ${APACHE_LOG_DIR}/onion-access.log combined
</VirtualHost>


# --- VHOST CLEARNET :80 (solo ACME + redirect 301 a https) ---
<VirtualHost *:80>
    ServerName sito.ufficiale.com
    ServerAlias www.sito.ufficiale.com
    ServerAdmin webmaster@sito.ufficiale.com

    # ACME webroot per certbot
    Alias /.well-known/acme-challenge/ "/var/www/.well-known/acme-challenge/"
    <Directory "/var/www/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # Tutto il resto: redirect a https (443)
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

    ErrorLog  ${APACHE_LOG_DIR}/clearnet80-error.log
    CustomLog ${APACHE_LOG_DIR}/clearnet80-access.log combined
</VirtualHost>


# --- VHOST CLEARNET :443 (TLS v1.2/v1.3, GCM, headers, Onion-Location) ---
<VirtualHost *:443>
    ServerName sito.ufficiale.com
    ServerAlias www.sito.ufficiale.com
    ServerAdmin webmaster@sito.ufficiale.com

    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    SSLEngine on
    # Let's Encrypt
    SSLCertificateFile      /etc/letsencrypt/live/sito.ufficiale.com/fullchain.pem
    SSLCertificateKeyFile   /etc/letsencrypt/live/sito.ufficiale.com/privkey.pem

    # Protocols: TLS 1.2 e 1.3
    SSLProtocol -all +TLSv1.2 +TLSv1.3

    # Cipher suite:
    # - TLSv1.3: impostazione standard (inclusi GCM)
    # - TLSv1.2: privilegia AES-GCM; escludi CBC/RC4/3DES
    SSLCipherSuite       ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder  on
    SSLCompression       off
    SSLUseStapling       on
    SSLStaplingCache     "shmcb:/var/run/apache2/stapling_cache(128000)"

    # HSTS (solo su clearnet, NON su onion)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Sicurezza base
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # CORS "safe": consenti caricamento asset senza rompere
    <If "%{REQUEST_METHOD} == 'GET' || %{REQUEST_METHOD} == 'HEAD'">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, HEAD"
        Header always set Access-Control-Allow-Headers "Content-Type"
    </If>

    # Pubblicizza il mirror onion (Onion-Location)
    # Necessita mod_headers + mod_rewrite; usa l'URI richiesto come variabile
    RewriteEngine On
    RewriteRule ^ - [E=REQ_URI:%{REQUEST_URI}]
    # Imposta l'header solo su richieste "normali" (evita acme-challenge)
    Header always set Onion-Location "http://sito.onion%{REQ_URI}e" env=REQ_URI

    ErrorLog  ${APACHE_LOG_DIR}/clearnet443-error.log
    CustomLog ${APACHE_LOG_DIR}/clearnet443-access.log combined
</VirtualHost>
